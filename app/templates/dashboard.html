<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h1 class="text-center mb-4">Dashboard</h1>
                {% for message, category in get_flashed_messages(with_categories=True) %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}

                {% if not session.get('video_file') %}
                <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">Choose a video:</label>
                        <input type="file" id="file" name="file" class="form-control-file" accept="video/*" required>
                    </div>
                    <input type="submit" value="Upload" class="btn btn-primary">
                </form>
                {% else %}
                <form method="post" action="{{ url_for('reset') }}" enctype="multipart/form-data">
                    <input type="submit" value="New" class="btn btn-primary">
                </form>
                {% endif %}

                {% if session.get('video_file') %}
                <h2 class="mt-4">Watch Video</h2>
                <video width="640" height="480" controls>
                    <source src="{{ url_for('uploaded_file', filename=session['video_file']) }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <form action="/analyse" method="get">
                    <input type="submit" id="analyse" name="analyse" value="Analyse" class="btn btn-primary">
                    
                </form>
                <!-- <div id="time"></div> -->
                {% endif %}
                {% if 'speech_data' in session %}

                

                <h2>Prediction</h2>
                <form method = 'POST'>
                    <div class="rangeslider" id="sliderRange"> 
                        <!-- <input type="range" min="0" max={{session['preds_str']|length - 1}} value="0" class="myslider" id="sliderRange">  -->
                        <p>
                            <span id="emotion">Emotion:</span>
                            <span id="curr_pred_str">{{session['speech_data']['preds_str'][0]}}</span>
                        </p> 
                        
                        <p>
                            <span id="details">Details</span>
                        </p> 
                        <ul>
                          

                            <li>Angry: <span id="angry"></span></li>
                            <li>Calm: <span id="calm"></span></li>
                            <li>Digust: <span id="disgust"></span></li>
                            <li>Fearful: <span id="fearful"></span></li>
                            <li>Happy: <span id="happy"></span></li>
                            <li>Neutral: <span id="neutral"></span></li>
                            <li>Sad: <span id="sad"></span></li>
                            <!-- <li>Surprised: <span id="surprised"></span></li> -->
                        </ul>
                    </div> 
                        
                    <script> 
                        const Http = new XMLHttpRequest();
                        var rangeslider = document.getElementById("sliderRange"); 
                        var output = document.getElementById("curr_pred_str"); 
                        var angry = document.getElementById("angry");
                        var calm = document.getElementById("calm");
                        var disgust = document.getElementById("disgust");
                        var fearful = document.getElementById("fearful");
                        var happy = document.getElementById("happy");
                        var neutral = document.getElementById("neutral");
                        var sad = document.getElementById("sad");
                        // var surprised = document.getElementById("surprised"); 
                        var current = 0;
                                    
                        // rangeslider.oninput = function() {
                        //     current = this.value;
                            
                        //     // if (current < 33){
                        //     //     output.innerHTML = 'Reverse';
                        //     //     current = 'reverse'
                        //     //     }
                        //     // else if (current >= 33 && current <= 66){
                        //     //     output.innerHTML = 'Neutral';
                        //     //     current = 'neutral'  
                        //     // }
                        //     // else if (current > 66){
                        //     //     output.innerHTML = 'Drive';
                        //     //     current = 'drive'
                        //     // }
                        
                        //     // I've added this call to the server, which send 'current' value
                        //     // Http.open('POST', '/slider_update')
                        //     // Http.send(current)
                        //     // console.log(JSON.stringify({idx: current}))
                        //     fetch('/slider_update', 
                        //         {
                        //             headers: {
                        //             'Accept': 'application/json',
                        //             'Content-Type': 'application/json'
                        //             },
                        //             method: "POST",
                        //             body: JSON.stringify({idx: current})
                        //         }
                        //     )
                        //     .then(resp => resp.json())
                        //     .then((data) => {
                        //         console.log(data)
                        //         output.innerHTML = data["pred"]
                        //         angry.innerHTML  = data['data']['angry']
                        //         calm.innerHTML  = data['data']['calm']
                        //         disgust.innerHTML  = data['data']['disgust']
                        //         fearful.innerHTML  = data['data']['fearful']
                        //         happy.innerHTML  = data['data']['happy']
                        //         neutral.innerHTML  = data['data']['neutral']
                        //         sad.innerHTML  = data['data']['sad']
                        //         surprised.innerHTML  = data['data']['surprised'];
                        //     })
                        // }
                        
                        var speech_data = {{speech_data|safe}};
                        console.log(speech_data)
                        rangeslider.update = function(value) {
                            current = value;
                            
                            // fetch('/slider_update', 
                            //     {
                            //         headers: {
                            //         'Accept': 'application/json',
                            //         'Content-Type': 'application/json'
                            //         },
                            //         method: "POST",
                            //         body: JSON.stringify({idx: current})
                            //     }
                            // )
                            // .then(resp => resp.json())
                            // .then((data) => {
                            //     console.log(data)
                            //     output.innerHTML = data["pred"]
                            //     angry.innerHTML  = data['data']['angry']
                            //     calm.innerHTML  = data['data']['calm']
                            //     disgust.innerHTML  = data['data']['disgust']
                            //     fearful.innerHTML  = data['data']['fearful']
                            //     happy.innerHTML  = data['data']['happy']
                            //     neutral.innerHTML  = data['data']['neutral']
                            //     sad.innerHTML  = data['data']['sad']
                            //     surprised.innerHTML  = data['data']['surprised'];
                            // })

                            // console.log(data)
                            output.innerHTML = speech_data["preds_str"][current]
                            angry.innerHTML  = speech_data["interps"][current]['angry']
                            calm.innerHTML  = speech_data["interps"][current]['calm']
                            disgust.innerHTML  = speech_data["interps"][current]['disgust']
                            fearful.innerHTML  = speech_data["interps"][current]['fearful']
                            happy.innerHTML  = speech_data["interps"][current]['happy']
                            neutral.innerHTML  = speech_data["interps"][current]['neutral']
                            sad.innerHTML  = speech_data["interps"][current]['sad']
                            // surprised.innerHTML  = speech_data["interps"][current]['surprised'];
                        }
            
                    </script> 

                        <script> 
                        (function() {
                        var video = document.getElementsByTagName('video')[0]
                        // var time = document.getElementById('time');
                        var rangeslider = document.getElementById("sliderRange"); 
                        video.addEventListener("timeupdate", function(event){
                            var idx = parseInt(video.currentTime);
                            // console.log(idx)
                            // time.innerHTML = idx;
                            // rangeslider.value = idx-1;
                            rangeslider.update(idx);
                        })
                        })();

                        </script> 
                
                
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</body>
</html>



